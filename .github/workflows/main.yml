name: Deploy WordPress to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Upload all WordPress files to EC2 (temporary folder)
      - name: Upload WordPress files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./"
          target: "/tmp/deploy"
          overwrite: true

      # Upload latest DB dump if it exists
      - name: Upload latest database dump
        if: hashFiles('db/latest_db.sql') != ''
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "db/latest_db.sql"
          target: "~/latest_db.sql"

      # Run deployment on EC2
      - name: Deploy to Apache webroot
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            WEB_ROOT="/srv/www/wordpress"
            HOME_DIR="$HOME"
            BACKUP_DIR="$HOME_DIR/backups"
            DB_NAME="${{ secrets.DB_NAME }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASS="${{ secrets.DB_PASS }}"

            echo "🔹 Creating backup directory..."
            mkdir -p $BACKUP_DIR

            echo "🔹 Backing up current database..."
            BACKUP_FILE="$BACKUP_DIR/db_backup_$(date +%F_%H-%M-%S).sql"
            mysqldump -u $DB_USER -p$DB_PASS $DB_NAME > "$BACKUP_FILE"
            echo "✅ Backup saved as $BACKUP_FILE"

            echo "🧹 Cleaning old backups (keeping latest 3)..."
            ls -tp $BACKUP_DIR/db_backup_*.sql | tail -n +4 | xargs -r rm --

            echo "🔹 Deploying new WordPress files..."
            sudo rm -rf ${WEB_ROOT:?}/*
            sudo mv /tmp/deploy/* $WEB_ROOT
            sudo chown -R www-data:www-data $WEB_ROOT
            sudo find $WEB_ROOT -type d -exec chmod 755 {} \;
            sudo find $WEB_ROOT -type f -exec chmod 644 {} \;

            echo "🔹 Importing latest database dump (if present)..."
            if [ -f $HOME_DIR/latest_db.sql ]; then
              mysql -u $DB_USER -p$DB_PASS $DB_NAME < $HOME_DIR/latest_db.sql
              rm $HOME_DIR/latest_db.sql
              echo "✅ Database imported."
            else
              echo "ℹ️ No new database dump found. Skipping import."
            fi

            echo "🔹 Restarting Apache..."
            sudo systemctl restart apache2

            echo "✅ Deployment complete!"
